name: Fashion Pipeline CD - Brazil Region

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  # Optimized for Brazil (São Paulo Region)
  REGION: southamerica-east1
  REPO_NAME: cabide-repo
  # GCS Bucket for permanent storage of generated catalog
  GCS_BUCKET: cabide-catalog-br

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Authentication
      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. Set up Cloud SDK
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      # 3. Configure Docker for the Brazil Region
      - name: 'Configure Docker'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 4. Build & Push Backend (API)
      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:${{ github.sha }}

      # 5. Build & Push Frontend (UI)
      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:${{ github.sha }}

      # 6. Deploy Backend to Cloud Run (São Paulo)
      - name: Deploy Backend to Cloud Run
        id: deploy-backend
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'cabide-api'
          image: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest'
          region: ${{ env.REGION }}
          env_vars: |
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GCS_BUCKET_NAME=${{ env.GCS_BUCKET }}

      # 7. Deploy Frontend to Cloud Run (São Paulo)
      - name: Deploy Frontend to Cloud Run
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'cabide-ui'
          image: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest'
          region: ${{ env.REGION }}
          flags: '--allow-unauthenticated'
          env_vars: |
            # Dynamically use the URL from the backend deployment
            BACKEND_URL=${{ steps.deploy-backend.outputs.url }}
