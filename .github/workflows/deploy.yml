name: Cabide AI Backend CD - Brazil Region

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  # Optimized for Brazil (São Paulo Region)
  REGION: southamerica-east1
  REPO_NAME: cabide-repo

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Authentication
      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SERVICE_ACCOUNT }}'

      # 2. Set up Cloud SDK
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      # 3. Configure Docker for the Brazil Region
      - name: 'Configure Docker'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 4. Build & Push Backend (API)
      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:${{ github.sha }}

      # 5. Deploy Backend to Cloud Run (São Paulo) - IAM-protected
      - name: Deploy Backend to Cloud Run
        id: deploy-backend
        run: |
          # Deploy with service account and env vars (NO public access)
          gcloud run deploy cabide-api \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest \
            --region=${{ env.REGION }} \
            --platform=managed \
            --no-allow-unauthenticated \
            --service-account=cabide-ai-uploader@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --set-env-vars=GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}",GDRIVE_FOLDER_ID="${{ secrets.GDRIVE_FOLDER_ID }}" \
            --format=json \
            --quiet > /tmp/deploy-output.json

          # Extract URL
          BACKEND_URL=$(jq -r '.status.url // empty' /tmp/deploy-output.json)
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $BACKEND_URL"

      # 6. Output Backend URL (for Streamlit Cloud configuration)
      - name: Show Backend URL
        run: echo "Backend deployed at ${{ steps.deploy-backend.outputs.url }}"
